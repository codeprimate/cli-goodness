#!/usr/bin/env ruby  
  
html_path = "doc/spec/report.html"  
  
system "rake spec" # run the spec. send progress to screen. save html results to html_path  
  
# find out how many errors were found  
html = open(html_path).read  
examples = html.match(/(\d+) examples/)[0].to_i rescue 0  
failures = html.match(/(\d+) failures/)[0].to_i rescue 0  
pending = html.match(/(\d+) pending/)[0].to_i rescue 0  

projectdesc = File.read("#{ENV['GIT_DIR']}/description")
  
if failures.zero?  
  puts "0 failures! #{examples} run, #{pending} pending"  
else  
  puts "\aDID NOT COMMIT YOUR FILES!"  
  puts "View spec results at #{File.expand_path(html_path)}"  
  puts  
  puts "#{failures} failures! #{examples} run, #{pending} pending"  

  system("twit \"has failing tests for #{projectdesc}\"")

  audiofile = "#{ENV['CLI_GOODNESS']}/git-goodness/Git_Fail.aif"
  system("sndplay '#{audiofile}'")

  exit 1  
end